# Prometheus alerting rules for AgentGuard

groups:
  - name: agentguard_api
    interval: 30s
    rules:
      # High error rate
      - alert: HighErrorRate
        expr: rate(agentguard_http_errors_total[5m]) > 0.05
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High API error rate detected"
          description: "Error rate is {{ $value | humanize }} errors/sec on {{ $labels.endpoint }}"

      # Critical error rate
      - alert: CriticalErrorRate
        expr: rate(agentguard_http_errors_total[5m]) > 0.1
        for: 3m
        labels:
          severity: critical
        annotations:
          summary: "CRITICAL: Very high API error rate"
          description: "Error rate is {{ $value | humanize }} errors/sec on {{ $labels.endpoint }}"

      # Slow requests (P95 > 1 second)
      - alert: SlowRequests
        expr: histogram_quantile(0.95, rate(agentguard_http_request_duration_seconds_bucket[5m])) > 1
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Slow API requests detected"
          description: "P95 latency is {{ $value | humanize }}s on {{ $labels.endpoint }}"

      # Very slow requests (P95 > 5 seconds)
      - alert: VerySlowRequests
        expr: histogram_quantile(0.95, rate(agentguard_http_request_duration_seconds_bucket[5m])) > 5
        for: 3m
        labels:
          severity: critical
        annotations:
          summary: "CRITICAL: Very slow API requests"
          description: "P95 latency is {{ $value | humanize }}s on {{ $labels.endpoint }}"

      # Rate limit violations
      - alert: HighRateLimitViolations
        expr: rate(agentguard_http_errors_total{status="429"}[5m]) > 0.1
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High rate limit violations"
          description: "{{ $value | humanize }} rate limit violations/sec"

  - name: agentguard_policy
    interval: 30s
    rules:
      # High policy denial rate
      - alert: HighPolicyDenialRate
        expr: rate(agentguard_policy_evaluations_total{outcome=~"denied.*"}[5m]) / rate(agentguard_policy_evaluations_total[5m]) > 0.5
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "High policy denial rate"
          description: "{{ $value | humanizePercentage }} of policy evaluations are being denied"

      # Agent with 100% denials
      - alert: AgentFullyBlocked
        expr: rate(agentguard_enforcement_total{allowed="False"}[10m]) > 0 unless rate(agentguard_enforcement_total{allowed="True"}[10m]) > 0
        for: 15m
        labels:
          severity: warning
        annotations:
          summary: "Agent {{ $labels.agent_id }} is fully blocked"
          description: "Agent {{ $labels.agent_id }} has all requests denied for 15+ minutes"

  - name: agentguard_database
    interval: 30s
    rules:
      # Database connection pool exhaustion
      - alert: DatabaseConnectionsHigh
        expr: agentguard_database_connections > 15
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Database connections are high"
          description: "{{ $value }} database connections in use (max 20)"

      # Database connection pool full
      - alert: DatabaseConnectionPoolFull
        expr: agentguard_database_connections >= 20
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "CRITICAL: Database connection pool exhausted"
          description: "All {{ $value }} database connections are in use"

  - name: agentguard_authentication
    interval: 30s
    rules:
      # High authentication failure rate
      - alert: HighAuthFailureRate
        expr: rate(agentguard_authentication_failures_total[5m]) > 0.5
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High authentication failure rate"
          description: "{{ $value | humanize }} auth failures/sec (type: {{ $labels.type }})"

      # Potential brute force attack
      - alert: PotentialBruteForce
        expr: rate(agentguard_authentication_failures_total[1m]) > 5
        for: 2m
        labels:
          severity: critical
        annotations:
          summary: "CRITICAL: Potential brute force attack"
          description: "{{ $value | humanize }} auth failures/sec - possible attack"

  - name: agentguard_system
    interval: 30s
    rules:
      # Service down
      - alert: ServiceDown
        expr: up{job="agentguard-backend"} == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "CRITICAL: AgentGuard service is down"
          description: "AgentGuard backend is not responding"

      # Low active agents (if expecting more)
      - alert: LowActiveAgents
        expr: agentguard_active_agents < 1
        for: 10m
        labels:
          severity: info
        annotations:
          summary: "Low number of active agents"
          description: "Only {{ $value }} active agents in the system"
